<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 6-7 çµ±åˆç¢ºèªãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffeaea; border-color: #f44336; }
        .test-result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— Phase 6-7 çµ±åˆç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
        
        <div id="testResults"></div>
        
        <button onclick="runIntegrationTests()" style="padding: 10px 20px; font-size: 16px; margin: 20px 0;">
            çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
    </div>

    <!-- Phase 6 Scripts -->
    <script src="js/kellyCapitalManager.js"></script>
    <script src="js/expectedValueCalculator.js"></script>
    <script src="js/bettingFilter.js"></script>
    <script src="js/phase6Integration.js"></script>
    
    <!-- Phase 7 Scripts -->
    <script src="js/portfolioDashboard.js"></script>
    <script src="js/performanceCharts.js"></script>
    
    <script>
        function runIntegrationTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h2>ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h2>';
            
            const tests = [];
            
            // Test 1: Phase 6ã‚¯ãƒ©ã‚¹ã®å­˜åœ¨ç¢ºèª
            try {
                const kellyManager = new KellyCapitalManager();
                tests.push({
                    name: 'Kelly Capital Manager åˆæœŸåŒ–',
                    result: 'SUCCESS',
                    message: 'Kellyè³‡é‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ'
                });
            } catch (error) {
                tests.push({
                    name: 'Kelly Capital Manager åˆæœŸåŒ–',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 2: Phase 7ã‚¯ãƒ©ã‚¹ã®å­˜åœ¨ç¢ºèª
            try {
                const portfolioDashboard = new PortfolioDashboard();
                tests.push({
                    name: 'Portfolio Dashboard åˆæœŸåŒ–',
                    result: 'SUCCESS',
                    message: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ'
                });
            } catch (error) {
                tests.push({
                    name: 'Portfolio Dashboard åˆæœŸåŒ–',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 3: Performance Charts ã‚¯ãƒ©ã‚¹ç¢ºèª
            try {
                const performanceCharts = new PerformanceCharts();
                tests.push({
                    name: 'Performance Charts åˆæœŸåŒ–',
                    result: 'SUCCESS',
                    message: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ'
                });
            } catch (error) {
                tests.push({
                    name: 'Performance Charts åˆæœŸåŒ–',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 4: ãƒ‡ãƒ¼ã‚¿é€£æºç¢ºèª
            try {
                const kellyManager = new KellyCapitalManager();
                const testCandidates = [
                    { 
                        horse: { name: 'ãƒ†ã‚¹ãƒˆé¦¬A', number: 1 },
                        winProbability: 0.25,
                        odds: 3.2,
                        expectedValue: 1.15,
                        confidence: 0.8,
                        raceId: 'test_race_1'
                    },
                    { 
                        horse: { name: 'ãƒ†ã‚¹ãƒˆé¦¬B', number: 3 },
                        winProbability: 0.20,
                        odds: 4.1,
                        expectedValue: 1.08,
                        confidence: 0.75,
                        raceId: 'test_race_1'
                    }
                ];
                
                const portfolioResult = kellyManager.calculatePortfolioAllocation(testCandidates);
                
                if (portfolioResult && portfolioResult.allocations) {
                    tests.push({
                        name: 'ãƒ‡ãƒ¼ã‚¿é€£æºãƒ†ã‚¹ãƒˆ',
                        result: 'SUCCESS',
                        message: `ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ (${portfolioResult.allocations.length}ä»¶ã®é…åˆ†)`
                    });
                } else {
                    tests.push({
                        name: 'ãƒ‡ãƒ¼ã‚¿é€£æºãƒ†ã‚¹ãƒˆ',
                        result: 'ERROR',
                        message: 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ'
                    });
                }
            } catch (error) {
                tests.push({
                    name: 'ãƒ‡ãƒ¼ã‚¿é€£æºãƒ†ã‚¹ãƒˆ',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 5: å¯è¦–åŒ–æ©Ÿèƒ½ç¢ºèª
            try {
                const portfolioDashboard = new PortfolioDashboard();
                
                // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                const testContainer = document.createElement('div');
                testContainer.id = 'test-dashboard-container';
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);
                
                portfolioDashboard.createDashboardContainer();
                
                tests.push({
                    name: 'å¯è¦–åŒ–æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ',
                    result: 'SUCCESS',
                    message: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ'
                });
                
                // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
                document.body.removeChild(testContainer);
            } catch (error) {
                tests.push({
                    name: 'å¯è¦–åŒ–æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 6: Phase 6 ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª
            try {
                const kellyManager = new KellyCapitalManager();
                const methods = [
                    'calculateKellyRatio',
                    'calculateOptimalBetAmount', 
                    'calculatePortfolioAllocation',
                    'applyRiskAdjustment'
                ];
                
                const availableMethods = methods.filter(method => 
                    typeof kellyManager[method] === 'function'
                );
                
                tests.push({
                    name: 'Kelly Manager ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª',
                    result: 'SUCCESS',
                    message: `åˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰: ${availableMethods.join(', ')} (${availableMethods.length}/${methods.length})`
                });
            } catch (error) {
                tests.push({
                    name: 'Kelly Manager ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª',
                    result: 'ERROR', 
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
            }
            
            // Test 7: Phase 7ã¨Phase 6ã®çµ±åˆãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
            try {
                const portfolioDashboard = new PortfolioDashboard();
                
                // ãƒ†ã‚¹ãƒˆç”¨ã®Kellyçµæœãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥
                const testKellyResults = {
                    totalInvestment: 2500,
                    expectedReturn: 2850,
                    mainCandidates: [
                        { horse: { name: 'ãƒ†ã‚¹ãƒˆé¦¬1' }, kellyRatio: 0.08, amount: 1000 },
                        { horse: { name: 'ãƒ†ã‚¹ãƒˆé¦¬2' }, kellyRatio: 0.05, amount: 800 }
                    ],
                    optionalCandidates: [
                        { horse: { name: 'ãƒ†ã‚¹ãƒˆé¦¬3' }, kellyRatio: 0.02, amount: 700 }
                    ],
                    riskMultiplier: 0.85
                };
                
                localStorage.setItem('kellyPortfolioResults', JSON.stringify(testKellyResults));
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®çµ±åˆãƒ†ã‚¹ãƒˆ
                portfolioDashboard.loadDataFromPhase6Systems();
                
                const hasData = portfolioDashboard.portfolioData && 
                               portfolioDashboard.portfolioData.mainCandidates &&
                               portfolioDashboard.portfolioData.mainCandidates.length > 0;
                
                if (hasData) {
                    tests.push({
                        name: 'Phase 6-7 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼çµ±åˆ',
                        result: 'SUCCESS',
                        message: `Kellyâ†’Dashboard ãƒ‡ãƒ¼ã‚¿é€£æºæˆåŠŸ (${portfolioDashboard.portfolioData.mainCandidates.length}ä»¶ã®ãƒ¡ã‚¤ãƒ³å€™è£œ)`
                    });
                } else {
                    tests.push({
                        name: 'Phase 6-7 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼çµ±åˆ',
                        result: 'ERROR',
                        message: 'ãƒ‡ãƒ¼ã‚¿é€£æºã«å¤±æ•—ã—ã¾ã—ãŸ'
                    });
                }
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                localStorage.removeItem('kellyPortfolioResults');
                
            } catch (error) {
                tests.push({
                    name: 'Phase 6-7 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼çµ±åˆ',
                    result: 'ERROR',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                });
                localStorage.removeItem('kellyPortfolioResults');
            }
            
            // çµæœè¡¨ç¤º
            displayTestResults(tests);
        }
        
        function displayTestResults(tests) {
            const resultsDiv = document.getElementById('testResults');
            let html = '<h2>ğŸ“Š çµ±åˆãƒ†ã‚¹ãƒˆçµæœ</h2>';
            
            const successCount = tests.filter(t => t.result === 'SUCCESS').length;
            const totalCount = tests.length;
            
            html += `<div class="test-section ${successCount === totalCount ? 'success' : 'error'}">
                <h3>ç·åˆçµæœ: ${successCount}/${totalCount} ãƒ†ã‚¹ãƒˆæˆåŠŸ</h3>
            </div>`;
            
            tests.forEach(test => {
                const className = test.result === 'SUCCESS' ? 'success' : 'error';
                html += `<div class="test-section ${className}">
                    <h4>${test.result === 'SUCCESS' ? 'âœ…' : 'âŒ'} ${test.name}</h4>
                    <div class="test-result">${test.message}</div>
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
            
            // çµ±åˆçŠ¶æ³ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            console.log('ğŸ“‹ Phase 6-7 çµ±åˆç¢ºèªå®Œäº†:', {
                success_rate: `${successCount}/${totalCount}`,
                kelly_manager: window.KellyCapitalManager ? 'Available' : 'Missing',
                portfolio_dashboard: window.PortfolioDashboard ? 'Available' : 'Missing',
                performance_charts: window.PerformanceCharts ? 'Available' : 'Missing'
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(runIntegrationTests, 500);
        });
    </script>
</body>
</html>