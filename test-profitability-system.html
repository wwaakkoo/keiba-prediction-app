<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç›Šæ€§ã‚·ã‚¹ãƒ†ãƒ  TDD ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; }
        .test-passed { color: green; }
        .test-failed { color: red; }
        .test-result { margin: 10px 0; padding: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>åç›Šæ€§é‡è¦–ã‚·ã‚¹ãƒ†ãƒ  TDD ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="test-results"></div>
    
    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="js/config.js"></script>
    <script src="js/profitabilityMetrics.js"></script>
    <script src="js/investmentEfficiencyCalculator.js"></script>
    <script src="js/underdogDiscoveryAlgorithm.js"></script>
    <script src="js/riskReturnAnalyzer.js"></script>
    <script src="js/enhancedLearningSystem.js"></script>
    
    <script>
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³
        class TDDTestRunner {
            constructor() {
                this.results = [];
            }
            
            test(name, testFunction) {
                try {
                    const result = testFunction();
                    if (result === true || result === undefined) {
                        this.results.push({ name, status: 'PASSED', message: 'ãƒ†ã‚¹ãƒˆæˆåŠŸ' });
                        console.log(`âœ… ${name}: PASSED`);
                    } else {
                        this.results.push({ name, status: 'FAILED', message: result || 'ãƒ†ã‚¹ãƒˆå¤±æ•—' });
                        console.log(`âŒ ${name}: FAILED - ${result}`);
                    }
                } catch (error) {
                    this.results.push({ name, status: 'ERROR', message: error.message });
                    console.log(`ğŸ’¥ ${name}: ERROR - ${error.message}`);
                }
            }
            
            assertEqual(actual, expected, message = '') {
                if (actual !== expected) {
                    throw new Error(`${message} - Expected: ${expected}, Actual: ${actual}`);
                }
            }
            
            assertTrue(condition, message = '') {
                if (!condition) {
                    throw new Error(`${message} - Expected: true, Actual: ${condition}`);
                }
            }
            
            assertGreaterThan(actual, expected, message = '') {
                if (actual <= expected) {
                    throw new Error(`${message} - Expected > ${expected}, Actual: ${actual}`);
                }
            }
            
            displayResults() {
                const container = document.getElementById('test-results');
                const passed = this.results.filter(r => r.status === 'PASSED').length;
                const total = this.results.length;
                
                container.innerHTML = `
                    <h2>ãƒ†ã‚¹ãƒˆçµæœ: ${passed}/${total} æˆåŠŸ</h2>
                    ${this.results.map(result => `
                        <div class="test-result test-${result.status.toLowerCase()}">
                            <strong>${result.status}</strong>: ${result.name}<br>
                            ${result.message}
                        </div>
                    `).join('')}
                `;
            }
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            const runner = new TDDTestRunner();
            
            // 1. ProfitabilityMetrics ãƒ†ã‚¹ãƒˆ
            runner.test('ProfitabilityMetrics - åŸºæœ¬åˆæœŸåŒ–', () => {
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                ProfitabilityMetrics.resetForTest();
                
                const data = ProfitabilityMetrics.getProfitabilityData();
                runner.assertTrue(data !== undefined, 'ãƒ‡ãƒ¼ã‚¿ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹');
                runner.assertTrue(data.investment !== undefined, 'æŠ•è³‡ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨');
                runner.assertEqual(data.investment.totalInvested, 0, 'åˆæœŸæŠ•è³‡é¡ã¯0');
            });
            
            runner.test('ProfitabilityMetrics - çš„ä¸­æ™‚ã®åç›Šè¨˜éŒ²', () => {
                // ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                ProfitabilityMetrics.resetForTest();
                
                const betResult = {
                    horseNumber: '1',
                    horseName: 'ãƒ†ã‚¹ãƒˆé¦¬',
                    odds: 10.0,
                    popularity: 8,
                    betType: 'å˜å‹',
                    betAmount: 1000,
                    isHit: true,
                    returnAmount: 10000
                };
                
                ProfitabilityMetrics.recordBetResult(betResult);
                const data = ProfitabilityMetrics.getProfitabilityData();
                
                runner.assertEqual(data.investment.totalInvested, 1000, 'æŠ•è³‡é¡ãŒè¨˜éŒ²ã•ã‚Œã‚‹');
                runner.assertEqual(data.investment.totalReturned, 10000, 'å›åé¡ãŒè¨˜éŒ²ã•ã‚Œã‚‹');
                runner.assertEqual(data.investment.totalProfit, 9000, 'åˆ©ç›ŠãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹');
                runner.assertEqual(data.coreMetrics.roi, 900, 'ROIãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹ï¼ˆ900%ï¼‰');
            });
            
            runner.test('ProfitabilityMetrics - å¤–ã‚Œæ™‚ã®æå¤±è¨˜éŒ²', () => {
                const betResult = {
                    horseNumber: '2',
                    horseName: 'ãƒ†ã‚¹ãƒˆé¦¬2',
                    odds: 5.0,
                    popularity: 3,
                    betType: 'å˜å‹',
                    betAmount: 1000,
                    isHit: false,
                    returnAmount: 0
                };
                
                ProfitabilityMetrics.recordBetResult(betResult);
                const data = ProfitabilityMetrics.getProfitabilityData();
                
                runner.assertEqual(data.investment.totalInvested, 2000, 'ç´¯ç©æŠ•è³‡é¡ãŒæ­£ã—ã„');
                runner.assertEqual(data.investment.totalReturned, 10000, 'ç´¯ç©å›åé¡ãŒæ­£ã—ã„');
                runner.assertEqual(data.investment.totalProfit, 8000, 'ç´¯ç©åˆ©ç›ŠãŒæ­£ã—ã„');
                runner.assertEqual(data.coreMetrics.roi, 400, 'ROIãŒæ­£ã—ãå†è¨ˆç®—ã•ã‚Œã‚‹ï¼ˆ400%ï¼‰');
            });
            
            // 2. InvestmentEfficiencyCalculator ãƒ†ã‚¹ãƒˆ
            runner.test('InvestmentEfficiencyCalculator - æœŸå¾…å€¤è¨ˆç®—', () => {
                const expectedValue = InvestmentEfficiencyCalculator.calculateExpectedValue(10.0, 0.15);
                runner.assertEqual(expectedValue, 1.5, 'æœŸå¾…å€¤è¨ˆç®—ãŒæ­£ã—ã„ï¼ˆ10Ã—0.15=1.5ï¼‰');
            });
            
            runner.test('InvestmentEfficiencyCalculator - ã‚±ãƒªãƒ¼åŸºæº–è¨ˆç®—', () => {
                const kellyFraction = InvestmentEfficiencyCalculator.calculateKellyFraction(10.0, 0.15);
                runner.assertTrue(kellyFraction >= 0, 'ã‚±ãƒªãƒ¼åŸºæº–ã¯éè² å€¤');
                runner.assertTrue(kellyFraction <= 0.25, 'ã‚±ãƒªãƒ¼åŸºæº–ã¯25%ä»¥ä¸‹ã«åˆ¶é™');
            });
            
            runner.test('InvestmentEfficiencyCalculator - ç©´é¦¬ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—', () => {
                const bonus1 = InvestmentEfficiencyCalculator.calculateUnderdogBonus(15.0, 12);
                const bonus2 = InvestmentEfficiencyCalculator.calculateUnderdogBonus(3.0, 2);
                
                runner.assertGreaterThan(bonus1, bonus2, 'é«˜ã‚ªãƒƒã‚ºãƒ»ä½äººæ°—ã»ã©é«˜ãƒœãƒ¼ãƒŠã‚¹');
                runner.assertTrue(bonus1 <= 20, 'ãƒœãƒ¼ãƒŠã‚¹ã¯20ä»¥ä¸‹');
            });
            
            runner.test('InvestmentEfficiencyCalculator - æŠ•è³‡åŠ¹ç‡è¨ˆç®—', () => {
                const betData = {
                    odds: 8.0,
                    winProbability: 0.2,
                    betAmount: 1000,
                    confidence: 0.7,
                    popularity: 9
                };
                
                const result = InvestmentEfficiencyCalculator.calculateSingleBetEfficiency(betData);
                
                runner.assertTrue(result.expectedValue > 0, 'æœŸå¾…å€¤ãŒè¨ˆç®—ã•ã‚Œã‚‹');
                runner.assertTrue(result.efficiencyScore >= 0 && result.efficiencyScore <= 100, 'åŠ¹ç‡ã‚¹ã‚³ã‚¢ãŒ0-100ç¯„å›²');
                runner.assertTrue(result.investmentGrade !== undefined, 'æŠ•è³‡ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒä»˜ä¸ã•ã‚Œã‚‹');
                runner.assertTrue(result.underdogBonus > 0, 'ç©´é¦¬ãƒœãƒ¼ãƒŠã‚¹ãŒä»˜ä¸ã•ã‚Œã‚‹');
            });
            
            // 3. UnderdogDiscoveryAlgorithm ãƒ†ã‚¹ãƒˆ
            runner.test('UnderdogDiscoveryAlgorithm - ç©´é¦¬å€™è£œãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°', () => {
                const horses = [
                    { name: 'äººæ°—é¦¬', odds: 2.5, popularity: 1 },
                    { name: 'ä¸­äººæ°—', odds: 5.0, popularity: 4 },
                    { name: 'ç©´é¦¬1', odds: 12.0, popularity: 8, age: 4 },
                    { name: 'ç©´é¦¬2', odds: 20.0, popularity: 12, age: 5 },
                    { name: 'é«˜é½¢é¦¬', odds: 15.0, popularity: 10, age: 9 }
                ];
                
                const candidates = UnderdogDiscoveryAlgorithm.filterUnderdogCandidates(horses);
                
                runner.assertEqual(candidates.length, 2, 'ç©´é¦¬å€™è£œãŒæ­£ã—ãæŠ½å‡ºã•ã‚Œã‚‹');
                runner.assertTrue(candidates.some(h => h.name === 'ç©´é¦¬1'), 'ç©´é¦¬1ãŒå«ã¾ã‚Œã‚‹');
                runner.assertTrue(candidates.some(h => h.name === 'ç©´é¦¬2'), 'ç©´é¦¬2ãŒå«ã¾ã‚Œã‚‹');
            });
            
            runner.test('UnderdogDiscoveryAlgorithm - ã‚ªãƒƒã‚ºãƒ¬ãƒ™ãƒ«åˆ†é¡', () => {
                runner.assertEqual(UnderdogDiscoveryAlgorithm.categorizeUnderdogLevel(25.0), 'BIG', '25å€ã¯å¤§ç©´');
                runner.assertEqual(UnderdogDiscoveryAlgorithm.categorizeUnderdogLevel(60.0), 'EXTREME', '60å€ã¯è¶…å¤§ç©´');
                runner.assertEqual(UnderdogDiscoveryAlgorithm.categorizeUnderdogLevel(8.0), 'MEDIUM', '8å€ã¯ä¸­ç©´');
            });
            
            // 4. RiskReturnAnalyzer ãƒ†ã‚¹ãƒˆ
            runner.test('RiskReturnAnalyzer - åŸºæœ¬çµ±è¨ˆè¨ˆç®—', () => {
                const investments = [
                    { betAmount: 1000, returnAmount: 1500, profit: 500 },
                    { betAmount: 1000, returnAmount: 0, profit: -1000 },
                    { betAmount: 1000, returnAmount: 3000, profit: 2000 }
                ];
                
                const stats = RiskReturnAnalyzer.calculateBasicStatistics(investments);
                
                runner.assertEqual(stats.totalAmount, 3000, 'ç·æŠ•è³‡é¡ãŒæ­£ã—ã„');
                runner.assertTrue(stats.avgReturn !== undefined, 'å¹³å‡ãƒªã‚¿ãƒ¼ãƒ³ãŒè¨ˆç®—ã•ã‚Œã‚‹');
                runner.assertTrue(stats.standardDeviation >= 0, 'æ¨™æº–åå·®ãŒéè² å€¤');
                runner.assertEqual(stats.positiveReturns, 2, 'ãƒ—ãƒ©ã‚¹ãƒªã‚¿ãƒ¼ãƒ³æ•°ãŒæ­£ã—ã„');
            });
            
            runner.test('RiskReturnAnalyzer - VaRè¨ˆç®—', () => {
                const returns = [-0.5, -0.2, 0.1, 0.3, 0.8, 1.5, -0.8, 0.2, -0.1, 0.4];
                const var95 = RiskReturnAnalyzer.calculateVaR(returns, 0.95);
                
                runner.assertTrue(var95 <= 0, 'VaRã¯é€šå¸¸è² ã®å€¤');
                runner.assertTrue(typeof var95 === 'number', 'VaRã¯æ•°å€¤');
            });
            
            // 5. EnhancedLearningSystem ãƒ†ã‚¹ãƒˆ
            runner.test('EnhancedLearningSystem - åç›Šæ€§ãƒ™ãƒ¼ã‚¹å­¦ç¿’', () => {
                const actualResults = {
                    winner: { name: 'ãƒ†ã‚¹ãƒˆå‹é¦¬', odds: 12.0, popularity: 8 },
                    allResults: [
                        { name: 'ãƒ†ã‚¹ãƒˆå‹é¦¬', odds: 12.0, popularity: 8 }
                    ]
                };
                
                const predictions = [
                    { name: 'ãƒ†ã‚¹ãƒˆå‹é¦¬', odds: 12.0, popularity: 8, pedigreeData: true, runningStyle: 'å…ˆè¡Œ' },
                    { name: 'ãƒ†ã‚¹ãƒˆ2ç€', odds: 5.0, popularity: 3 }
                ];
                
                const learningResults = EnhancedLearningSystem.processBasicLearning(actualResults, predictions);
                
                runner.assertTrue(learningResults !== undefined, 'å­¦ç¿’çµæœãŒè¿”ã•ã‚Œã‚‹');
                runner.assertTrue(learningResults.adjustments !== undefined, 'èª¿æ•´çµæœãŒå«ã¾ã‚Œã‚‹');
            });
            
            runner.test('EnhancedLearningSystem - ç©´é¦¬è¦å› åˆ†æ', () => {
                const horse = {
                    name: 'ãƒ†ã‚¹ãƒˆç©´é¦¬',
                    pedigreeData: true,
                    runningStyle: 'å·®ã—',
                    jockey: 'ãƒ†ã‚¹ãƒˆé¨æ‰‹',
                    lastRaceResult: { finish: 3 },
                    age: 4
                };
                
                const factors = EnhancedLearningSystem.analyzeUnderdogFactors(horse);
                
                runner.assertEqual(factors.pedigree, 1.0, 'è¡€çµ±è¦å› ãŒæ¤œå‡ºã•ã‚Œã‚‹');
                runner.assertEqual(factors.runningStyle, 1.0, 'è„šè³ªè¦å› ãŒæ¤œå‡ºã•ã‚Œã‚‹');
                runner.assertEqual(factors.jockey, 1.0, 'é¨æ‰‹è¦å› ãŒæ¤œå‡ºã•ã‚Œã‚‹');
                runner.assertEqual(factors.form, 1.0, 'èª¿æ•™ãƒ»çŠ¶æ…‹è¦å› ãŒæ¤œå‡ºã•ã‚Œã‚‹');
            });
            
            runner.test('EnhancedLearningSystem - ã‚ªãƒƒã‚ºå¸¯åˆ†é¡', () => {
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(1.2), 'ultraLow', '1.2å€ã¯è¶…ä½ã‚ªãƒƒã‚º');
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(2.5), 'low', '2.5å€ã¯ä½ã‚ªãƒƒã‚º');
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(5.0), 'medium', '5.0å€ã¯ä¸­ã‚ªãƒƒã‚º');
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(10.0), 'high', '10.0å€ã¯é«˜ã‚ªãƒƒã‚º');
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(25.0), 'veryHigh', '25.0å€ã¯è¶…é«˜ã‚ªãƒƒã‚º');
                runner.assertEqual(EnhancedLearningSystem.classifyOddsRange(100.0), 'extreme', '100.0å€ã¯æ¥µç«¯ã‚ªãƒƒã‚º');
            });
            
            // 6. çµ±åˆãƒ†ã‚¹ãƒˆ
            runner.test('çµ±åˆãƒ†ã‚¹ãƒˆ - åç›Šæ€§é‡è¦–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼', () => {
                // 1. è³­ã‘çµæœã‚’è¨˜éŒ²
                const betResult = {
                    horseNumber: '1',
                    horseName: 'çµ±åˆãƒ†ã‚¹ãƒˆé¦¬',
                    odds: 15.0,
                    popularity: 9,
                    betType: 'å˜å‹',
                    betAmount: 1000,
                    isHit: true,
                    returnAmount: 15000
                };
                
                ProfitabilityMetrics.recordBetResult(betResult);
                
                // 2. æŠ•è³‡åŠ¹ç‡ã‚’è¨ˆç®—
                const betData = {
                    odds: 15.0,
                    winProbability: 0.1,
                    betAmount: 1000,
                    confidence: 0.8,
                    popularity: 9
                };
                
                const efficiencyResult = InvestmentEfficiencyCalculator.calculateSingleBetEfficiency(betData);
                
                // 3. ç©´é¦¬åˆ†æ
                const horses = [{ name: 'çµ±åˆãƒ†ã‚¹ãƒˆé¦¬', odds: 15.0, popularity: 9, age: 5 }];
                const underdogCandidates = UnderdogDiscoveryAlgorithm.filterUnderdogCandidates(horses);
                
                // 4. çµ±åˆæ¤œè¨¼
                runner.assertTrue(efficiencyResult.isUnderdog, 'ç©´é¦¬ã¨ã—ã¦èªè­˜ã•ã‚Œã‚‹');
                runner.assertEqual(underdogCandidates.length, 1, 'ç©´é¦¬å€™è£œã¨ã—ã¦æŠ½å‡ºã•ã‚Œã‚‹');
                runner.assertGreaterThan(efficiencyResult.underdogBonus, 0, 'ç©´é¦¬ãƒœãƒ¼ãƒŠã‚¹ãŒä»˜ä¸ã•ã‚Œã‚‹');
                
                const profitData = ProfitabilityMetrics.getProfitabilityData();
                runner.assertGreaterThan(profitData.coreMetrics.roi, 0, 'ROIãŒãƒ—ãƒ©ã‚¹');
            });
            
            // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤º
            runner.displayResults();
        });
    </script>
</body>
</html>