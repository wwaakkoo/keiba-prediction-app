# 期待値ベース買い目システム開発計画

## 📋 プロジェクト概要

**目的**: 高精度な複勝予想（81.8%）を活用しながら、トリガミ問題を解決する期待値ベースの買い目システムを構築

**現在の問題点**:
- 複勝予想的中率81.8%だが、総回収率11.8%（-5,280円）
- 人気馬偏重（低配当）により資金効率が悪い
- 3連複BOXやワイドの的中率6.1%と低迷

## 🎯 開発戦略

### 期待値ベースアプローチ
```
期待値 = 的中確率 × オッズ
期待値 ≥ 1.3 → 買い推奨
期待値 < 1.0 → 見送り
```

### 人気層×スコア組み合わせルール
- **人気馬（1-3番人気）**: スコア90%以上でないと買わない
- **中人気（4-6番人気）**: スコア70%以上を推奨（メインターゲット）
- **穴馬（7番人気以下）**: スコア50%以上で補助的に活用

## 🔧 実装フェーズ

### Phase 1: 期待値計算システム（最重要）✅ 完了
- [x] スコア→的中確率変換機能
- [x] 期待値計算エンジン
- [x] 馬券種別期待値評価
- [x] 現実的な期待値計算（市場効率性・胴元優位性考慮）
- [x] 期待値ベース買い目推奨セクション
- [x] オッズ偏重問題の修正

### Phase 2: 買い目フィルタリング（効果大）✅ 完了
- [x] 人気層×スコアフィルター
- [x] 期待値閾値フィルター
- [x] 馬券種別適性判定
- [x] 買い目候補生成
- [x] 複数条件組み合わせフィルター

### Phase 3: 見送り判定ロジック（収益改善）✅ 完了
- [x] レース全体の期待値評価
- [x] 高度な見送り条件設定（5つの分析軸による多角的判定）
- [x] 投資効率判定
- [x] 資金管理統合
- [x] 見送り履歴の記録・分析

### Phase 4: 動的買い方変更（最適化）✅ 完了
- [x] 複勝1点/2点動的切り替え
- [x] ワイド組み合わせ最適化
- [x] 投資額動的調整
- [x] パフォーマンス追跡
- [x] レース特性に応じた戦略変更

### Phase 5: キャリブレーション機能（精度向上）✅ 完了
- [x] バケットキャリブレーション
- [x] ロジスティック回帰による確率推定
- [x] スコア→的中確率の精度向上
- [x] 人気層別キャリブレーション
- [x] 季節・コース別調整

### Phase 6: 高度な資金管理（長期収益最大化）
- [ ] ケリー基準による資金配分
- [ ] 期待値に応じた可変ベット
- [ ] リスク管理の強化
- [ ] 連敗時の資金保護
- [ ] 投資効率の最適化

### Phase 7: 可視化・分析ツール（運用支援）
- [ ] 期待値プロット
- [ ] スコア別的中率チャート
- [ ] 人気層別成績分析
- [ ] 時系列パフォーマンス追跡
- [ ] 買い目戦略比較分析

### Phase 8: システム最適化（運用改善）
- [ ] 馬番表示の修正
- [ ] UIの改善
- [ ] パフォーマンスの向上
- [ ] エラーハンドリング強化
- [ ] データ保存・復元機能

## 📊 Phase 1-3 完了成果

### ✅ 実装完了機能
- **期待値計算システム**: 市場効率性を考慮した現実的期待値計算
- **買い目フィルタリング**: 人気層×スコア×期待値による多重フィルタリング
- **見送り判定システム**: 5つの分析軸による科学的見送り判定
- **統合推奨システム**: 期待値+フィルタリング+従来分析の統合表示
- **学習システム改善**: 複勝・ワイド・3連複の判定バグ修正

### 📈 技術的達成
- トリガミ問題の科学的解決アプローチ構築
- 期待値1.3以上の優良馬券自動検出
- 見送り閾値60点による投資判断自動化
- 複数組み合わせ買い目の正確な的中判定

## 📊 成功指標

### 目標KPI
- **的中率**: 30%以上（現状6.1%から大幅改善）
- **回収率**: 110%以上（現状11.8%から大幅改善）
- **見送り率**: 30-50%（優良レースの選別）
- **期待値精度**: 実績期待値との誤差±10%以内

### 測定項目
- 人気層別成績
- 期待値レンジ別成績
- 馬券種別効率
- 月間収支推移

## 🎨 設計思想

### 「精度×妙味」のバランス
- 高精度な複勝予想を基盤に
- 配当効率を重視したフィルタリング
- データドリブンな意思決定

### 「見送り」の概念
- 毎レース買わない勇気
- 優良機会への資金集中
- 長期的な資金効率向上

### 動的な戦略変更
- レース構造に応じた柔軟な対応
- 固定的な買い方からの脱却
- 継続的な学習と改善

## 🔬 検証計画

### 過去データ検証
- 11レース実績データでの検証
- 期待値計算の精度確認
- フィルタリング効果の測定

### 実運用テスト
- 少額での実運用テスト
- パフォーマンス追跡
- 戦略の段階的改善

## 📈 期待効果

### 短期効果（1-2ヶ月）
- トリガミ問題の解決
- 見送り機能による損失抑制
- 買い目精度の向上

### 中長期効果（3-6ヶ月）
- 期待値精度の向上
- 季節・コース別最適化
- 安定した収益基盤の構築

## 💻 技術仕様

### 主要コンポーネント
- `ExpectedValueCalculator`: 期待値計算エンジン
- `BettingFilter`: 買い目フィルタリング
- `RaceEvaluator`: レース評価・見送り判定
- `DynamicBettingStrategy`: 動的買い方変更

### データ構造
```javascript
{
  horse: {
    number: 1,
    score: 75.5,
    odds: 4.2,
    popularity: 5,
    expectedValue: 1.26,
    probability: 0.3,
    recommendation: 'buy'
  },
  race: {
    totalExpectedValue: 1.15,
    recommendation: 'participate',
    strategy: 'place_2_horses',
    budget: 500
  }
}
```

---

**開発開始日**: 2024年1月
**開発チーム**: Claude Code
**目標完成日**: Phase 1-2 完了を優先