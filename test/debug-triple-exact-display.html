<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” 3é€£å˜æ¨å¥¨è¡¨ç¤ºãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .recommendation-display { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” 3é€£å˜æ¨å¥¨è¡¨ç¤ºãƒ‡ãƒãƒƒã‚°</h1>
    
    <div class="debug-section">
        <h2>ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ã®ç›®çš„</h2>
        <p>3é€£å˜ã®è²·ã„ç›®æ¨å¥¨ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã‚’èª¿æŸ»ã—ã¾ã™ã€‚</p>
        <ul>
            <li>æ¨å¥¨ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ç¢ºèª</li>
            <li>å°åˆ†é¡ã®ç¢ºèª</li>
            <li>æœŸå¾…å€¤è¨ˆç®—ã®ç¢ºèª</li>
            <li>è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®ç¢ºèª</li>
        </ul>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ‡ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®š</h2>
        <button onclick="setupDebugData()">ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š</button>
        <button onclick="runDebugTest()">3é€£å˜æ¨å¥¨ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ</button>
        <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
        
        <div id="testDataInfo" class="info debug-section" style="display: none;">
            <h4>è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿</h4>
            <div id="horseDataDisplay"></div>
        </div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ” å°åˆ†é¡ãƒ‡ãƒãƒƒã‚°</h2>
        <div id="marksDebug" class="info debug-section">
            å°åˆ†é¡å¾…æ©Ÿä¸­...
        </div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“Š æœŸå¾…å€¤è¨ˆç®—ãƒ‡ãƒãƒƒã‚°</h2>
        <div id="calculationDebug" class="info debug-section">
            æœŸå¾…å€¤è¨ˆç®—å¾…æ©Ÿä¸­...
        </div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ¯ æ¨å¥¨ç”Ÿæˆãƒ‡ãƒãƒƒã‚°</h2>
        <div id="recommendationDebug" class="info debug-section">
            æ¨å¥¨ç”Ÿæˆå¾…æ©Ÿä¸­...
        </div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“± å®Ÿéš›ã®æ¨å¥¨è¡¨ç¤º</h2>
        <div id="actualRecommendations"></div>
    </div>
    
    <div class="debug-section">
        <h2>ğŸ“ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
        <pre id="debugLog">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...\n</pre>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="../js/config.js"></script>
    <script src="../js/bettingRecommender.js"></script>
    
    <script>
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let debugPredictions = [];
        let debugLogs = [];
        
        // ãƒ­ã‚°é–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            debugLogs.push(args.join(' '));
            originalConsoleLog.apply(console, args);
            updateDebugLog();
        };
        
        function updateDebugLog() {
            document.getElementById('debugLog').textContent = debugLogs.slice(-30).join('\n');
        }
        
        function addDebugLog(message) {
            debugLogs.push(`[DEBUG] ${new Date().toLocaleTimeString()} ${message}`);
            updateDebugLog();
        }
        
        // ãƒ¢ãƒƒã‚¯å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
        class LearningSystem {
            static getLearningData() {
                return {
                    adjustments: { oddsWeight: 1.0, timeWeight: 1.0, jockeyWeight: 1.0 }
                };
            }
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®š
        function setupDebugData() {
            debugPredictions = [
                {
                    name: "ã‚µãƒ³ãƒ©ã‚¤ã‚ºãƒ›ãƒ¼ãƒ—",
                    odds: 2.1,
                    winProbability: 25.3,
                    placeProbability: 65.2,
                    winExpectedValue: 1.2
                },
                {
                    name: "ãƒŸãƒ©ã‚¯ãƒ«ã‚¹ã‚¿ãƒ¼", 
                    odds: 4.5,
                    winProbability: 18.7,
                    placeProbability: 58.1,
                    winExpectedValue: 0.8
                },
                {
                    name: "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒœãƒ«ãƒˆ",
                    odds: 7.2,
                    winProbability: 12.4,
                    placeProbability: 45.3,
                    winExpectedValue: 0.9
                },
                {
                    name: "ã‚·ãƒ«ãƒãƒ¼ã‚¢ãƒ­ãƒ¼",
                    odds: 12.8,
                    winProbability: 8.1,
                    placeProbability: 38.7,
                    winExpectedValue: 1.0
                },
                {
                    name: "ã‚¯ãƒªãƒ ã‚¾ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ",
                    odds: 18.4,
                    winProbability: 5.2,
                    placeProbability: 28.9,
                    winExpectedValue: 0.95
                }
            ];
            
            const horseDataDisplay = document.getElementById('horseDataDisplay');
            horseDataDisplay.innerHTML = debugPredictions.map((horse, i) => `
                <p><strong>${i+1}. ${horse.name}</strong> - ã‚ªãƒƒã‚º:${horse.odds}å€ å‹ç‡:${horse.winProbability}% è¤‡å‹ç‡:${horse.placeProbability}%</p>
            `).join('');
            
            document.getElementById('testDataInfo').style.display = 'block';
            addDebugLog('ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }
        
        function getHorseNumber(horseName) {
            const index = debugPredictions.findIndex(h => h.name === horseName);
            return index !== -1 ? index + 1 : '?';
        }
        
        function runDebugTest() {
            if (debugPredictions.length === 0) {
                alert('ã¾ãšãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            addDebugLog('3é€£å˜æ¨å¥¨ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹');
            
            try {
                // Step 1: å°åˆ†é¡ã®ãƒ†ã‚¹ãƒˆ
                addDebugLog('Step 1: å°åˆ†é¡ã‚’å®Ÿè¡Œä¸­...');
                const sortedByWinProbability = [...debugPredictions].sort((a, b) => b.winProbability - a.winProbability);
                const sortedByWinExpected = [...debugPredictions].sort((a, b) => b.winExpectedValue - a.winExpectedValue);
                
                const marks = BettingRecommender.classifyHorses(
                    debugPredictions,
                    sortedByWinProbability,
                    sortedByWinExpected
                );
                
                displayMarksDebug(marks);
                
                // Step 2: 3é€£å˜æ¨å¥¨ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆ
                addDebugLog('Step 2: 3é€£å˜æ¨å¥¨ç”Ÿæˆã‚’å®Ÿè¡Œä¸­...');
                const tripleExactRecommendations = BettingRecommender.generateTripleExactRecommendations(
                    marks,
                    debugPredictions,
                    getHorseNumber
                );
                
                displayRecommendationDebug(tripleExactRecommendations);
                
                // Step 3: æœŸå¾…å€¤è¨ˆç®—ã®è©³ç´°ãƒ†ã‚¹ãƒˆ
                addDebugLog('Step 3: æœŸå¾…å€¤è¨ˆç®—ã®è©³ç´°ç¢ºèª...');
                if (marks.honmei && marks.taikou && marks.tanana) {
                    const detailedCalculation = BettingRecommender.calculateTripleExactExpectedValue(
                        [marks.honmei, marks.taikou, marks.tanana],
                        debugPredictions
                    );
                    displayCalculationDebug(detailedCalculation, [marks.honmei, marks.taikou, marks.tanana]);
                }
                
                // Step 4: å®Ÿéš›ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
                addDebugLog('Step 4: å®Ÿéš›ã®æ¨å¥¨è¡¨ç¤ºãƒ†ã‚¹ãƒˆ...');
                const allRecommendations = BettingRecommender.generateRecommendationsFromMarks(marks, getHorseNumber);
                displayActualRecommendations(allRecommendations, marks);
                
                addDebugLog('ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                addDebugLog(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`);
                console.error('ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function displayMarksDebug(marks) {
            const marksDebug = document.getElementById('marksDebug');
            marksDebug.innerHTML = `
                <h4>å°åˆ†é¡çµæœ</h4>
                <p><strong>â— æœ¬å‘½:</strong> ${marks.honmei ? marks.honmei.name : 'ãªã—'}</p>
                <p><strong>â—‹ å¯¾æŠ—:</strong> ${marks.taikou ? marks.taikou.name : 'ãªã—'}</p>
                <p><strong>â–² å˜ç©´:</strong> ${marks.tanana ? marks.tanana.name : 'ãªã—'}</p>
                <p><strong>â–³ é€£è¤‡:</strong> ${marks.renpuku ? marks.renpuku.name : 'ãªã—'}</p>
                <p><strong>å°æ•°:</strong> ${[marks.honmei, marks.taikou, marks.tanana, marks.renpuku].filter(h => h).length}é ­</p>
                <p><strong>3é€£å˜æ¡ä»¶:</strong> ${[marks.honmei, marks.taikou, marks.tanana, marks.renpuku].filter(h => h).length >= 3 ? 'âœ… æº€ãŸã™' : 'âŒ ä¸è¶³'}</p>
            `;
            
            addDebugLog(`å°åˆ†é¡å®Œäº†: æœ¬å‘½=${marks.honmei?.name}, å¯¾æŠ—=${marks.taikou?.name}, å˜ç©´=${marks.tanana?.name}, é€£è¤‡=${marks.renpuku?.name}`);
        }
        
        function displayCalculationDebug(calculation, horses) {
            const calculationDebug = document.getElementById('calculationDebug');
            calculationDebug.innerHTML = `
                <h4>æœŸå¾…å€¤è¨ˆç®—è©³ç´°</h4>
                <p><strong>å¯¾è±¡é¦¬:</strong> ${horses.map(h => h.name).join(' â†’ ')}</p>
                <p><strong>çš„ä¸­ç¢ºç‡:</strong> ${calculation.hitProbability.toFixed(3)}%</p>
                <p><strong>æ¨å®šé…å½“:</strong> ${calculation.estimatedDividend}å€</p>
                <p><strong>åŠ¹ç‡:</strong> ${calculation.efficiency.toFixed(3)}</p>
                <p><strong>é–¾å€¤åˆ¤å®š:</strong> ${calculation.efficiency > 0.08 ? 'âœ… æ¨å¥¨åŸºæº–ã‚¯ãƒªã‚¢' : 'âŒ æ¨å¥¨åŸºæº–æœªé”'}</p>
                <p><strong>æ¨å¥¨åŸºæº–:</strong> åŠ¹ç‡ > 0.08</p>
            `;
            
            addDebugLog(`æœŸå¾…å€¤è¨ˆç®—: åŠ¹ç‡=${calculation.efficiency.toFixed(3)}, çš„ä¸­ç‡=${calculation.hitProbability.toFixed(3)}%, é…å½“=${calculation.estimatedDividend}å€`);
        }
        
        function displayRecommendationDebug(recommendations) {
            const recommendationDebug = document.getElementById('recommendationDebug');
            
            if (recommendations.length === 0) {
                recommendationDebug.innerHTML = `
                    <h4>âŒ 3é€£å˜æ¨å¥¨ç”Ÿæˆçµæœ</h4>
                    <p><strong>ç”Ÿæˆæ•°:</strong> 0ä»¶</p>
                    <p><strong>åŸå› :</strong> åŠ¹ç‡åŸºæº–ã‚’æº€ãŸã™çµ„ã¿åˆã‚ã›ãªã—ã€ã¾ãŸã¯å°ä¸è¶³</p>
                `;
                recommendationDebug.className = 'error debug-section';
                addDebugLog('3é€£å˜æ¨å¥¨ç”Ÿæˆ: 0ä»¶ï¼ˆæ¨å¥¨åŸºæº–æœªé”ã¾ãŸã¯å°ä¸è¶³ï¼‰');
            } else {
                recommendationDebug.innerHTML = `
                    <h4>âœ… 3é€£å˜æ¨å¥¨ç”Ÿæˆçµæœ</h4>
                    <p><strong>ç”Ÿæˆæ•°:</strong> ${recommendations.length}ä»¶</p>
                    ${recommendations.map((rec, i) => `
                        <div class="recommendation-display">
                            <h5>æ¨å¥¨ #${i+1}</h5>
                            <p><strong>ã‚¿ã‚¤ãƒ—:</strong> ${rec.type}</p>
                            <p><strong>é¦¬:</strong> ${rec.horse}</p>
                            <p><strong>ç¢ºç‡:</strong> ${rec.probability}</p>
                            <p><strong>é…å½“:</strong> ${rec.odds}</p>
                            <p><strong>åŠ¹ç‡:</strong> ${rec.efficiency ? rec.efficiency.toFixed(3) : 'N/A'}</p>
                        </div>
                    `).join('')}
                `;
                recommendationDebug.className = 'success debug-section';
                addDebugLog(`3é€£å˜æ¨å¥¨ç”Ÿæˆ: ${recommendations.length}ä»¶ç”Ÿæˆ`);
            }
        }
        
        function displayActualRecommendations(allRecommendations, marks) {
            const container = document.getElementById('actualRecommendations');
            
            addDebugLog(`å…¨æ¨å¥¨ç”Ÿæˆ: åˆè¨ˆ${allRecommendations.length}ä»¶`);
            
            // 3é€£å˜ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const tripleExactOnly = allRecommendations.filter(rec => rec.category === '3é€£å˜');
            addDebugLog(`3é€£å˜æ¨å¥¨ãƒ•ã‚£ãƒ«ã‚¿çµæœ: ${tripleExactOnly.length}ä»¶`);
            
            if (tripleExactOnly.length === 0) {
                container.innerHTML = `
                    <div class="error debug-section">
                        <h4>âŒ 3é€£å˜æ¨å¥¨ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</h4>
                        <p>å…¨æ¨å¥¨æ•°: ${allRecommendations.length}ä»¶</p>
                        <p>3é€£å˜æ¨å¥¨æ•°: 0ä»¶</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="success debug-section">
                        <h4>âœ… 3é€£å˜æ¨å¥¨è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h4>
                        <p>å…¨æ¨å¥¨æ•°: ${allRecommendations.length}ä»¶</p>
                        <p>3é€£å˜æ¨å¥¨æ•°: ${tripleExactOnly.length}ä»¶</p>
                        ${tripleExactOnly.map((rec, i) => `
                            <div class="recommendation-display">
                                <h5>${rec.category} #${i+1}</h5>
                                <p><strong>å°:</strong> ${rec.mark}</p>
                                <p><strong>ã‚¿ã‚¤ãƒ—:</strong> ${rec.type}</p>
                                <p><strong>é¦¬:</strong> ${rec.horse}</p>
                                <p><strong>ã‚ªãƒƒã‚º:</strong> ${rec.odds}</p>
                                <p><strong>ç¢ºç‡:</strong> ${rec.probability}</p>
                                <p><strong>æ¨å¥¨é‡‘é¡:</strong> ${rec.amount}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        function clearResults() {
            document.getElementById('marksDebug').innerHTML = 'å°åˆ†é¡å¾…æ©Ÿä¸­...';
            document.getElementById('calculationDebug').innerHTML = 'æœŸå¾…å€¤è¨ˆç®—å¾…æ©Ÿä¸­...';
            document.getElementById('recommendationDebug').innerHTML = 'æ¨å¥¨ç”Ÿæˆå¾…æ©Ÿä¸­...';
            document.getElementById('actualRecommendations').innerHTML = '';
            document.getElementById('testDataInfo').style.display = 'none';
        }
        
        function clearLog() {
            debugLogs = [];
            updateDebugLog();
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('3é€£å˜æ¨å¥¨è¡¨ç¤ºãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            
            if (typeof BettingRecommender !== 'undefined') {
                addDebugLog('âœ… BettingRecommenderã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                
                if (typeof BettingRecommender.generateTripleExactRecommendations === 'function') {
                    addDebugLog('âœ… generateTripleExactRecommendations ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™');
                } else {
                    addDebugLog('âŒ generateTripleExactRecommendations ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                if (typeof BettingRecommender.calculateTripleExactExpectedValue === 'function') {
                    addDebugLog('âœ… calculateTripleExactExpectedValue ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™');
                } else {
                    addDebugLog('âŒ calculateTripleExactExpectedValue ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } else {
                addDebugLog('âŒ BettingRecommenderã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>