<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐎 穴馬学習改善テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .horse-item { padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd; }
        .recommended { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border: 2px solid #4caf50; }
        .candidate { background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 1px solid #ff9800; }
        .result-hit { color: #4caf50; font-weight: bold; }
        .result-miss { color: #f44336; font-weight: bold; }
        .learning-pattern { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐎 穴馬学習システム改善テスト</h1>
        
        <div class="test-section">
            <h2>📊 現在の仕組み検証</h2>
            <div id="current-system-test">
                <h3>1. 緑背景表示条件テスト</h3>
                <button class="btn-primary" onclick="testGreenBackgroundLogic()">緑背景表示テスト</button>
                <div id="green-background-result"></div>
                
                <h3>2. ▲単穴推奨条件テスト</h3>
                <button class="btn-primary" onclick="testTananaRecommendation()">単穴推奨テスト</button>
                <div id="tanana-recommendation-result"></div>
                
                <h3>3. 現在の穴馬学習条件テスト</h3>
                <button class="btn-primary" onclick="testCurrentSleeperLearning()">現在学習条件テスト</button>
                <div id="current-learning-result"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>🎯 実際のケーステスト（2025/7/5のレース）</h2>
            <div id="actual-case-test">
                <div class="horse-item">
                    <strong>ルクスメンデス</strong> - 94.9倍 - <span class="result-hit">1着</span>
                    <div>状態: <span id="lukus-status">検証中...</span></div>
                </div>
                <div class="horse-item">
                    <strong>エイシンマールス</strong> - 6倍 - <span class="result-hit">2着</span>
                    <div>状態: <span id="eishin-status">検証中...</span></div>
                </div>
                <div class="horse-item">
                    <strong>ジューンセレッソ</strong> - 124.8倍 - <span class="result-hit">3着</span>
                    <div>状態: <span id="june-status">検証中...</span></div>
                </div>
                <div class="horse-item">
                    <strong>エーグルドール</strong> - 6.9倍 - <span class="result-miss">圏外</span>
                    <div>状態: <span id="eagle-status">検証中...</span></div>
                </div>
                <button class="btn-success" onclick="analyzeActualCase()">実際のケースを分析</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>🚀 改善案テスト</h2>
            <div id="improvement-test">
                <h3>新しい学習ルール</h3>
                <div class="learning-pattern">
                    <strong>パターンA</strong>: ▲単穴推奨馬の成否学習<br>
                    対象: エーグルドール（推奨 → 圏外）
                </div>
                <div class="learning-pattern">
                    <strong>パターンB</strong>: 穴馬候補見落とし学習<br>
                    対象: ルクスメンデス（候補だが非推奨 → 1着）
                </div>
                <div class="learning-pattern">
                    <strong>パターンC</strong>: 穴馬候補見落とし学習<br>
                    対象: ジューンセレッソ（候補だが非推奨 → 3着）
                </div>
                
                <button class="btn-warning" onclick="testImprovedLearning()">改善案をテスト</button>
                <div id="improved-learning-result"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>📈 学習効果シミュレーション</h2>
            <div id="learning-simulation">
                <p>改善前後の学習データ比較</p>
                <div id="before-after-comparison"></div>
                <button class="btn-success" onclick="simulateLearningEffect()">学習効果をシミュレーション</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>🎯 実装予定コード</h2>
            <div id="implementation-preview">
                <textarea id="code-preview" style="width: 100%; height: 200px; font-family: monospace;">
// 改善予定のコード構造

class ImprovedSleeperLearning {
    // 1. 推奨判断（1頭に絞る）
    static getRecommendedSleeper(predictions) {
        // 現在の▲単穴推奨ロジックを維持
    }
    
    // 2. 学習対象抽出（1-3頭に拡張）
    static extractLearningTargets(predictions, recommendations) {
        // ▲単穴推奨馬 + 緑背景高オッズ馬
    }
    
    // 3. 拡張学習実行
    static learnFromExpandedTargets(learningTargets, actualResults) {
        // 成功/失敗/見落とし全パターンを学習
    }
}
                </textarea>
                <button class="btn-primary" onclick="updateCodePreview()">実装コードプレビュー更新</button>
            </div>
        </div>
    </div>

    <script>
        // テスト用のサンプルデータ
        const testRaceData = {
            horses: [
                { name: 'ルクスメンデス', odds: 94.9, actualPosition: 1, popularity: 16 },
                { name: 'エイシンマールス', odds: 6.0, actualPosition: 2, popularity: 6 },
                { name: 'ジューンセレッソ', odds: 124.8, actualPosition: 3, popularity: 14 },
                { name: 'エーグルドール', odds: 6.9, actualPosition: 0, popularity: 7 },
                { name: 'テスト馬A', odds: 3.2, actualPosition: 0, popularity: 2 },
                { name: 'テスト馬B', odds: 15.5, actualPosition: 0, popularity: 10 },
                { name: 'テスト馬C', odds: 28.3, actualPosition: 0, popularity: 12 }
            ]
        };
        
        // 1. 緑背景表示条件テスト
        function testGreenBackgroundLogic() {
            const result = document.getElementById('green-background-result');
            let output = '<h4>緑背景表示条件: オッズ5倍以上</h4>';
            
            testRaceData.horses.forEach(horse => {
                const isGreenBackground = horse.odds >= 5.0;
                const bgClass = isGreenBackground ? 'candidate' : '';
                output += `<div class="horse-item ${bgClass}">
                    ${horse.name} (${horse.odds}倍) - ${isGreenBackground ? '✅ 緑背景' : '❌ 通常'}
                </div>`;
            });
            
            const greenCount = testRaceData.horses.filter(h => h.odds >= 5.0).length;
            output += `<p><strong>緑背景表示馬数: ${greenCount}/${testRaceData.horses.length}頭</strong></p>`;
            
            result.innerHTML = output;
        }
        
        // 2. ▲単穴推奨条件テスト
        function testTananaRecommendation() {
            const result = document.getElementById('tanana-recommendation-result');
            
            // 簡易的な単穴推奨ロジック再現
            const candidates = testRaceData.horses.filter(horse => 
                horse.odds >= 5 && horse.odds <= 20 // 中オッズ帯
            );
            
            // 期待値で並び替え（簡易計算）
            candidates.forEach(horse => {
                horse.expectedValue = (1/horse.odds) * horse.odds * 0.15; // 仮の期待値
            });
            
            const recommended = candidates.sort((a, b) => b.expectedValue - a.expectedValue)[0];
            
            let output = '<h4>▲単穴推奨条件: オッズ5-20倍で期待値最高</h4>';
            
            if (recommended) {
                output += `<div class="horse-item recommended">
                    <strong>推奨: ${recommended.name}</strong> (${recommended.odds}倍) 
                    - 実際: ${recommended.actualPosition ? recommended.actualPosition + '着' : '圏外'}
                    ${recommended.actualPosition && recommended.actualPosition <= 3 ? '<span class="result-hit"> ✅ 的中</span>' : '<span class="result-miss"> ❌ 外れ</span>'}
                </div>`;
            }
            
            result.innerHTML = output;
        }
        
        // 3. 現在の穴馬学習条件テスト
        function testCurrentSleeperLearning() {
            const result = document.getElementById('current-learning-result');
            
            // 現在の学習条件（detectSleeper基準）を簡易再現
            let output = '<h4>現在の学習条件: detectSleeper判定のみ</h4>';
            
            testRaceData.horses.forEach(horse => {
                // 簡易的なdetectSleeper条件
                let sleeperScore = 0;
                if (horse.odds >= 6) sleeperScore += 10;
                if (horse.odds >= 8) sleeperScore += 10;
                // その他の条件は省略
                
                const isLearningTarget = sleeperScore >= 20;
                const actualHit = horse.actualPosition && horse.actualPosition <= 3;
                
                if (isLearningTarget) {
                    output += `<div class="horse-item ${actualHit ? 'result-hit' : 'result-miss'}">
                        ${horse.name} (${horse.odds}倍) - 学習対象 - ${actualHit ? '的中' : '外れ'}
                    </div>`;
                }
            });
            
            result.innerHTML = output;
        }
        
        // 4. 実際のケース分析
        function analyzeActualCase() {
            // 各馬の状態を更新
            document.getElementById('lukus-status').innerHTML = '緑背景候補・非推奨 → <span class="result-hit">見落とし</span>';
            document.getElementById('eishin-status').innerHTML = '緑背景候補・非推奨 → <span class="result-hit">見落とし</span>';
            document.getElementById('june-status').innerHTML = '緑背景候補・非推奨 → <span class="result-hit">見落とし（現在学習済み）</span>';
            document.getElementById('eagle-status').innerHTML = '緑背景候補・推奨 → <span class="result-miss">失敗</span>';
        }
        
        // 5. 改善案テスト
        function testImprovedLearning() {
            const result = document.getElementById('improved-learning-result');
            
            let output = '<h4>改善案による学習対象拡張</h4>';
            
            // 推奨馬の学習
            output += '<div class="learning-pattern"><strong>推奨馬学習</strong>: エーグルドール → 失敗パターン学習</div>';
            
            // 見落とし馬の学習
            const highOddsHits = testRaceData.horses.filter(h => h.odds >= 15 && h.actualPosition <= 3);
            highOddsHits.forEach(horse => {
                output += `<div class="learning-pattern"><strong>見落とし学習</strong>: ${horse.name} (${horse.odds}倍・${horse.actualPosition}着) → 見落とし要因分析</div>`;
            });
            
            output += '<p><strong>学習データ量</strong>: 現在1件 → 改善後3件（3倍の学習効率）</p>';
            
            result.innerHTML = output;
        }
        
        // 6. 学習効果シミュレーション
        function simulateLearningEffect() {
            const result = document.getElementById('before-after-comparison');
            
            const simulation = `
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #f8f9fa;">
                    <th style="border: 1px solid #ddd; padding: 8px;">項目</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">改善前</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">改善後</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">学習対象馬数/レース</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">1頭</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">1-3頭</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">見落とし学習</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">なし</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">あり</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">ルクスメンデスケース</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">学習されない</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">見落とし学習される</td>
                </tr>
            </table>
            `;
            
            result.innerHTML = simulation;
        }
        
        // 7. 実装コードプレビュー更新
        function updateCodePreview() {
            const preview = document.getElementById('code-preview');
            preview.value = `
// 穴馬学習システム改善実装コード

class ImprovedSleeperLearning {
    
    // 学習対象拡張抽出
    static extractExpandedLearningTargets(predictions, bettingRecommendations) {
        const targets = [];
        
        // 1. ▲単穴推奨馬は必ず学習対象
        if (bettingRecommendations.tanana) {
            targets.push({
                horse: bettingRecommendations.tanana,
                type: 'RECOMMENDED',
                reason: '単穴推奨馬'
            });
        }
        
        // 2. 緑背景で高オッズ（15倍以上）の馬も学習対象
        predictions.forEach(horse => {
            if (horse.isUnderdog && horse.odds >= 15 && 
                !targets.some(t => t.horse.name === horse.name)) {
                targets.push({
                    horse: horse,
                    type: 'HIGH_ODDS_CANDIDATE',
                    reason: '高オッズ穴馬候補'
                });
            }
        });
        
        return targets;
    }
    
    // 拡張学習実行
    static performExpandedLearning(learningTargets, actualTop3) {
        learningTargets.forEach(target => {
            const isHit = actualTop3.some(horse => horse.name === target.horse.name);
            const position = isHit ? actualTop3.findIndex(h => h.name === target.horse.name) + 1 : null;
            
            // 学習パターン判定
            let learningPattern;
            if (target.type === 'RECOMMENDED') {
                learningPattern = isHit ? 'RECOMMENDATION_SUCCESS' : 'RECOMMENDATION_FAILURE';
            } else {
                learningPattern = isHit ? 'OVERSIGHT_DISCOVERY' : 'CORRECT_EXCLUSION';
            }
            
            // 学習データに記録
            this.recordExpandedLearningPattern({
                date: new Date().toISOString(),
                horseName: target.horse.name,
                odds: target.horse.odds,
                type: target.type,
                pattern: learningPattern,
                isHit: isHit,
                position: position,
                reason: target.reason
            });
        });
    }
}`;
        }
        
        // 初期表示
        window.onload = function() {
            testGreenBackgroundLogic();
        };
    </script>
</body>
</html>