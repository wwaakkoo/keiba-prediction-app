<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; margin: 5px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .horse-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .underdog { background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50; }
    </style>
</head>
<body>
    <h1>ğŸ”„ ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ¦‚è¦</h2>
        <p>æŠ•è³‡åŠ¹ç‡é †ãƒ»ç©´é¦¬å€™è£œé †ã®ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
    </div>

    <div class="test-section">
        <h2>âš™ï¸ ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ç¢ºèª</h2>
        <div id="sortStatus"></div>
        <button class="btn btn-primary" onclick="testSortFunctions()">ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn btn-success" onclick="generateTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª äºˆæ¸¬ãƒ»ã‚½ãƒ¼ãƒˆå®Ÿè¡Œãƒ†ã‚¹ãƒˆ</h2>
        <div class="btn-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <button class="btn btn-primary" onclick="testPredictionWithSort('score')">ã‚¹ã‚³ã‚¢é †</button>
            <button class="btn btn-primary" onclick="testPredictionWithSort('efficiency')">ğŸ’ æŠ•è³‡åŠ¹ç‡é †</button>
            <button class="btn btn-primary" onclick="testPredictionWithSort('underdog')">ğŸ ç©´é¦¬å€™è£œé †</button>
            <button class="btn btn-primary" onclick="testPredictionWithSort('odds')">ã‚ªãƒƒã‚ºé †</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š ã‚½ãƒ¼ãƒˆçµæœè¡¨ç¤º</h2>
        <div id="sortResults"></div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/config.js"></script>
    <script src="js/pedigreeDatabase.js"></script>
    <script src="js/dataConverter.js"></script>
    <script src="js/horseManager.js"></script>
    <script src="js/dataManager.js"></script>
    <script src="js/raceAnalysisEngine.js"></script>
    <script src="js/predictionEngine.js"></script>
    <script src="js/bettingRecommender.js"></script>
    <script src="js/learningSystem.js"></script>
    <script src="js/hybridLearningSystem.js"></script>
    <script src="js/enhancedLearningSystem.js"></script>
    <script src="js/profitabilityMetrics.js"></script>
    <script src="js/investmentEfficiencyCalculator.js"></script>
    <script src="js/underdogDiscoveryAlgorithm.js"></script>
    <script src="js/riskReturnAnalyzer.js"></script>
    <script src="js/profitabilityVisualizationSystem.js"></script>
    <script src="js/enhancedVisualizationSystem.js"></script>
    <script src="js/learningDataMigration.js"></script>
    <script src="js/aiRecommendationService.js"></script>
    <script src="js/errorHandlingSystem.js"></script>
    <script src="js/systemIntegration.js"></script>
    <script src="js/main.js"></script>

    <script>
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(message, type = 'info', duration = 3000) {
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        function testSortFunctions() {
            const statusDiv = document.getElementById('sortStatus');
            let results = [];
            
            try {
                // PredictionEngineã®å­˜åœ¨ç¢ºèª
                if (typeof PredictionEngine !== 'undefined') {
                    results.push('<div class="status success">âœ… PredictionEngineèª­ã¿è¾¼ã¿æ¸ˆã¿</div>');
                } else {
                    results.push('<div class="status error">âŒ PredictionEngineæœªèª­ã¿è¾¼ã¿</div>');
                    statusDiv.innerHTML = results.join('');
                    return;
                }

                // changeSortOrderé–¢æ•°ã®å­˜åœ¨ç¢ºèª
                if (typeof PredictionEngine.changeSortOrder === 'function') {
                    results.push('<div class="status success">âœ… changeSortOrderé–¢æ•°</div>');
                } else {
                    results.push('<div class="status error">âŒ changeSortOrderé–¢æ•°ãªã—</div>');
                }

                // renderSortedResultsé–¢æ•°ã®å­˜åœ¨ç¢ºèª
                if (typeof PredictionEngine.renderSortedResults === 'function') {
                    results.push('<div class="status success">âœ… renderSortedResultsé–¢æ•°</div>');
                } else {
                    results.push('<div class="status error">âŒ renderSortedResultsé–¢æ•°ãªã—</div>');
                }

                // InvestmentEfficiencyCalculatorå­˜åœ¨ç¢ºèª
                if (typeof InvestmentEfficiencyCalculator !== 'undefined') {
                    results.push('<div class="status success">âœ… InvestmentEfficiencyCalculatorèª­ã¿è¾¼ã¿æ¸ˆã¿</div>');
                } else {
                    results.push('<div class="status error">âŒ InvestmentEfficiencyCalculatoræœªèª­ã¿è¾¼ã¿</div>');
                }

                // estimatePopularityFromOddsé–¢æ•°ç¢ºèª
                if (typeof estimatePopularityFromOdds === 'function') {
                    results.push('<div class="status success">âœ… estimatePopularityFromOddsé–¢æ•°</div>');
                } else {
                    results.push('<div class="status warning">âš ï¸ estimatePopularityFromOddsé–¢æ•°ï¼ˆäºˆæ¸¬ã‚¨ãƒ³ã‚¸ãƒ³å†…ã§å®šç¾©æ¸ˆã¿ï¼‰</div>');
                }

            } catch (error) {
                results.push(`<div class="status error">âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            }
            
            statusDiv.innerHTML = results.join('');
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateTestData() {
            try {
                // ãƒ†ã‚¹ãƒˆç”¨é¦¬ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const testHorses = [
                    {
                        name: 'ãƒ†ã‚¹ãƒˆé¦¬A',
                        jockey: 'ãƒ†ã‚¹ãƒˆé¨æ‰‹1',
                        weight: '500',
                        odds: 15.2,
                        age: '4',
                        recentForm: '3',
                        lastRaceOrder: '1',
                        jockeyWinRate: '0.20'
                    },
                    {
                        name: 'ãƒ†ã‚¹ãƒˆé¦¬B',
                        jockey: 'ãƒ†ã‚¹ãƒˆé¨æ‰‹2', 
                        weight: '495',
                        odds: 3.1,
                        age: '5',
                        recentForm: '2',
                        lastRaceOrder: '2',
                        jockeyWinRate: '0.25'
                    },
                    {
                        name: 'ãƒ†ã‚¹ãƒˆé¦¬C',
                        jockey: 'ãƒ†ã‚¹ãƒˆé¨æ‰‹3',
                        weight: '510',
                        odds: 8.5,
                        age: '3',
                        recentForm: '4',
                        lastRaceOrder: '3',
                        jockeyWinRate: '0.15'
                    },
                    {
                        name: 'ãƒ†ã‚¹ãƒˆé¦¬D',
                        jockey: 'ãƒ†ã‚¹ãƒˆé¨æ‰‹4',
                        weight: '485',
                        odds: 25.0,
                        age: '6',
                        recentForm: '1',
                        lastRaceOrder: '5',
                        jockeyWinRate: '0.18'
                    }
                ];

                // HorseManagerã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                if (typeof HorseManager !== 'undefined') {
                    HorseManager.horses = testHorses;
                    showMessage('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†', 'success');
                }

            } catch (error) {
                showMessage(`âŒ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // äºˆæ¸¬ãƒ»ã‚½ãƒ¼ãƒˆå®Ÿè¡Œãƒ†ã‚¹ãƒˆ
        function testPredictionWithSort(sortType) {
            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç”Ÿæˆ
                if (!HorseManager.horses || HorseManager.horses.length === 0) {
                    generateTestData();
                }

                // äºˆæ¸¬å®Ÿè¡Œ
                const predictions = PredictionEngine.calculateHorsePredictions();
                console.log('äºˆæ¸¬çµæœ:', predictions);

                if (predictions && predictions.length > 0) {
                    // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
                    PredictionEngine.renderSortedResults(sortType);
                    
                    // çµæœè¡¨ç¤º
                    displaySortResults(predictions, sortType);
                    
                    showMessage(`âœ… ${sortType}ã‚½ãƒ¼ãƒˆå®Ÿè¡Œå®Œäº†`, 'success');
                } else {
                    showMessage('âŒ äºˆæ¸¬çµæœãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }

            } catch (error) {
                showMessage(`âŒ äºˆæ¸¬ãƒ»ã‚½ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚½ãƒ¼ãƒˆçµæœè¡¨ç¤º
        function displaySortResults(predictions, sortType) {
            const resultsDiv = document.getElementById('sortResults');
            
            // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
            let sortedPredictions = [...predictions];
            let sortTitle = '';
            
            switch(sortType) {
                case 'efficiency':
                    sortedPredictions.sort((a, b) => (b.efficiencyScore || 0) - (a.efficiencyScore || 0));
                    sortTitle = 'ğŸ’ æŠ•è³‡åŠ¹ç‡é †';
                    break;
                case 'underdog':
                    sortedPredictions.sort((a, b) => {
                        if (a.isUnderdog && !b.isUnderdog) return -1;
                        if (!a.isUnderdog && b.isUnderdog) return 1;
                        return (b.efficiencyScore || 0) - (a.efficiencyScore || 0);
                    });
                    sortTitle = 'ğŸ ç©´é¦¬å€™è£œé †';
                    break;
                case 'odds':
                    sortedPredictions.sort((a, b) => a.odds - b.odds);
                    sortTitle = 'ğŸ’° ã‚ªãƒƒã‚ºé †ï¼ˆäººæ°—é †ï¼‰';
                    break;
                default:
                    sortedPredictions.sort((a, b) => b.score - a.score);
                    sortTitle = 'ğŸ“Š ã‚¹ã‚³ã‚¢é †';
            }

            let html = `<h3>${sortTitle}</h3>`;
            
            sortedPredictions.forEach((horse, index) => {
                const isUnderdog = horse.isUnderdog || false;
                const cardClass = isUnderdog ? 'horse-card underdog' : 'horse-card';
                
                html += `
                    <div class="${cardClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${index + 1}. ${horse.name}</strong>
                                ${isUnderdog ? ' ğŸğŸ’' : ''}
                            </div>
                            <div>
                                <span>ã‚ªãƒƒã‚º: ${horse.odds}</span>
                                <span style="margin-left: 10px;">ã‚¹ã‚³ã‚¢: ${horse.score?.toFixed(1) || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                            åŠ¹ç‡ã‚¹ã‚³ã‚¢: ${horse.efficiencyScore?.toFixed(1) || 'N/A'} | 
                            ã‚°ãƒ¬ãƒ¼ãƒ‰: ${horse.investmentGrade || 'N/A'} |
                            å‹ç‡: ${horse.winProbability?.toFixed(1) || 'N/A'}%
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testSortFunctions();
            }, 1000);
        });
    </script>
</body>
</html>