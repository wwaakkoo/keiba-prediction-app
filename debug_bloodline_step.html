<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>血統ステップデバッグ</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
            max-height: 500px; 
            overflow-y: auto; 
            border: 1px solid #ddd;
        }
        .step { color: #007bff; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>🔍 血統ステップデバッグ</h1>
    <p>DataConverterの血統抽出プロセスを詳細にログ出力</p>
    
    <button onclick="debugBloodlineExtraction()">血統ステップ詳細デバッグ実行</button>
    <div id="results"></div>

    <script src="js/dataConverter.js"></script>
    <script>
        function debugBloodlineExtraction() {
            const resultsDiv = document.getElementById('results');
            
            // テストデータ（1頭目のみ）
            const testData = `1\t1\t
消
ロードカナロア
ベラジオオペラ
エアルーティーン
(ハービンジャー)
栗東・上村  
先中9週
510kg(+2)
4.0 (1人気)
牡5鹿

横山和
58.0\t`;

            console.clear();
            console.log('=== 血統ステップ詳細デバッグ開始 ===');
            
            try {
                // DataConverterのparseAllHorsesWithPedigreeを直接呼び出し
                const horses = DataConverter.parseAllHorsesWithPedigree(testData);
                
                let html = '<h3>🔍 血統ステップ詳細ログ</h3>';
                
                if (horses.length > 0) {
                    const horse = horses[0];
                    
                    html += `
                        <h4>抽出結果</h4>
                        <p><strong>馬名:</strong> ${horse.name || '未抽出'}</p>
                        <p><strong>父系:</strong> ${horse.sire || '未抽出'}</p>
                        <p><strong>母系:</strong> ${horse.dam || '未抽出'}</p>
                        <p><strong>母父:</strong> ${horse.damSire || '未抽出'}</p>
                    `;
                    
                    if (horse.processLog) {
                        html += '<h4>処理ログ</h4>';
                        html += `<div class="log">${horse.processLog.join('\n')}</div>`;
                    }
                    
                    // 各ステップでの判定結果を表示
                    html += '<h4>📋 各行の判定詳細</h4>';
                    const lines = testData.split('\n').map(line => line.trim()).filter(line => line);
                    const testLines = ['消', 'ロードカナロア', 'ベラジオオペラ', 'エアルーティーン', '(ハービンジャー)'];
                    
                    testLines.forEach((line, index) => {
                        html += `<div style="border: 1px solid #ddd; padding: 8px; margin: 5px 0;">`;
                        html += `<strong>行${index + 1}: "${line}"</strong><br>`;
                        html += `isMarkLine: ${DataConverter.isMarkLine ? DataConverter.isMarkLine(line) : 'メソッドなし'}<br>`;
                        html += `isSire: ${DataConverter.isSire ? DataConverter.isSire(line) : 'メソッドなし'}<br>`;
                        html += `isPotentialSire(step=1): ${DataConverter.isPotentialSire ? DataConverter.isPotentialSire(line, 1) : 'メソッドなし'}<br>`;
                        html += `isPotentialHorseName: ${DataConverter.isPotentialHorseName ? DataConverter.isPotentialHorseName(line) : 'メソッドなし'}<br>`;
                        html += `isMare: ${DataConverter.isMare ? DataConverter.isMare(line) : 'メソッドなし'}<br>`;
                        html += `isPotentialMare(step=3): ${DataConverter.isPotentialMare ? DataConverter.isPotentialMare(line, 3) : 'メソッドなし'}<br>`;
                        html += `extractDamSire: ${DataConverter.extractDamSire ? DataConverter.extractDamSire(line) : 'メソッドなし'}`;
                        html += `</div>`;
                    });
                    
                } else {
                    html += '<p class="error">❌ 馬データが抽出されませんでした</p>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ エラー発生</h3>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                console.error('血統ステップデバッグエラー:', error);
            }
        }
        
        // ページ読み込み時にメソッドの存在確認
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DataConverterメソッド確認 ===');
            console.log('parseAllHorsesWithPedigree:', typeof DataConverter?.parseAllHorsesWithPedigree);
            console.log('isMarkLine:', typeof DataConverter?.isMarkLine);
            console.log('isSire:', typeof DataConverter?.isSire);
            console.log('isPotentialSire:', typeof DataConverter?.isPotentialSire);
            console.log('isPotentialHorseName:', typeof DataConverter?.isPotentialHorseName);
            console.log('isMare:', typeof DataConverter?.isMare);
            console.log('isPotentialMare:', typeof DataConverter?.isPotentialMare);
            console.log('extractDamSire:', typeof DataConverter?.extractDamSire);
        });
    </script>
</body>
</html>