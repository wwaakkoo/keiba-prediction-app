<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDD Green Phase: åç›Šæ€§ã‚°ãƒ©ãƒ• ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-passed { color: green; font-weight: bold; }
        .test-failed { color: red; font-weight: bold; }
        .test-result { margin: 5px 0; padding: 3px; }
        .summary { background: #f0f0f0; padding: 15px; border-radius: 5px; margin-top: 20px; }
        #learningGraphsSection { margin-top: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ğŸŸ¢ TDD Green Phase: åç›Šæ€§ã‚°ãƒ©ãƒ•ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼</h1>
    
    <div id="test-container"></div>
    <div class="summary" id="test-summary"></div>
    
    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="learningGraphsSection"></div>
    
    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="js/config.js"></script>
    <script src="js/profitabilityMetrics.js"></script>
    <script src="js/investmentEfficiencyCalculator.js"></script>
    <script src="js/underdogDiscoveryAlgorithm.js"></script>
    <script src="js/riskReturnAnalyzer.js"></script>
    <script src="js/profitabilityVisualizationSystem.js"></script>
    
    <script>
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³
        class BrowserTDDTest {
            constructor() {
                this.passed = 0;
                this.failed = 0;
                this.total = 0;
                this.results = [];
            }
            
            test(name, testFunction) {
                this.total++;
                try {
                    const result = testFunction();
                    if (result !== false) {
                        this.results.push({ name, status: 'PASSED', message: 'ãƒ†ã‚¹ãƒˆæˆåŠŸ' });
                        this.passed++;
                        return true;
                    } else {
                        this.results.push({ name, status: 'FAILED', message: 'ãƒ†ã‚¹ãƒˆå¤±æ•—' });
                        this.failed++;
                        return false;
                    }
                } catch (error) {
                    this.results.push({ name, status: 'ERROR', message: error.message });
                    this.failed++;
                    return false;
                }
            }
            
            assertEqual(actual, expected, message = '') {
                if (actual !== expected) {
                    throw new Error(`${message} - Expected: ${expected}, Actual: ${actual}`);
                }
            }
            
            assertTrue(condition, message = '') {
                if (!condition) {
                    throw new Error(`${message} - Expected: true, Actual: ${condition}`);
                }
            }
            
            displayResults() {
                const container = document.getElementById('test-container');
                const summary = document.getElementById('test-summary');
                
                let html = '';
                let currentSection = '';
                
                this.results.forEach(result => {
                    const statusClass = result.status === 'PASSED' ? 'test-passed' : 'test-failed';
                    const icon = result.status === 'PASSED' ? 'âœ…' : 'âŒ';
                    
                    html += `
                        <div class="test-result ${statusClass}">
                            ${icon} ${result.name}: ${result.message}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                const successRate = ((this.passed / this.total) * 100).toFixed(1);
                summary.innerHTML = `
                    <h3>ğŸ“Š TDD Green Phase ãƒ†ã‚¹ãƒˆçµæœ</h3>
                    <p><strong>æˆåŠŸ: ${this.passed}/${this.total} (${successRate}%)</strong></p>
                    <p>å¤±æ•—: ${this.failed}</p>
                    ${this.passed === this.total ? 
                        '<p style="color: green; font-weight: bold;">ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼TDD Green Phaseå®Œäº†ï¼</p>' : 
                        '<p style="color: red; font-weight: bold;">âš ï¸ ä¸€éƒ¨ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚</p>'
                    }
                `;
                
                return this.passed === this.total;
            }
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            const tdd = new BrowserTDDTest();
            
            console.log('=== TDD Green Phase: ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            // 1. åŸºæœ¬ã‚¯ãƒ©ã‚¹ãƒ†ã‚¹ãƒˆ
            tdd.test('ProfitabilityVisualizationSystemã‚¯ãƒ©ã‚¹å­˜åœ¨', () => {
                tdd.assertTrue(typeof ProfitabilityVisualizationSystem !== 'undefined', 'ã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹');
                tdd.assertTrue(ProfitabilityVisualizationSystem.charts instanceof Map, 'chartsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒMap');
                tdd.assertTrue(typeof ProfitabilityVisualizationSystem.config === 'object', 'configãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ');
            });
            
            tdd.test('Chart.jsèª­ã¿è¾¼ã¿ç¢ºèª', () => {
                tdd.assertTrue(typeof Chart !== 'undefined', 'Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹');
                tdd.assertTrue(typeof Chart.register === 'function', 'Chart.js APIåˆ©ç”¨å¯èƒ½');
            });
            
            tdd.test('ä¾å­˜ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ç¢ºèª', () => {
                tdd.assertTrue(typeof ProfitabilityMetrics !== 'undefined', 'ProfitabilityMetricsèª­ã¿è¾¼ã¿æ¸ˆã¿');
                tdd.assertTrue(typeof InvestmentEfficiencyCalculator !== 'undefined', 'InvestmentEfficiencyCalculatorèª­ã¿è¾¼ã¿æ¸ˆã¿');
                tdd.assertTrue(typeof UnderdogDiscoveryAlgorithm !== 'undefined', 'UnderdogDiscoveryAlgorithmèª­ã¿è¾¼ã¿æ¸ˆã¿');
                tdd.assertTrue(typeof RiskReturnAnalyzer !== 'undefined', 'RiskReturnAnalyzerèª­ã¿è¾¼ã¿æ¸ˆã¿');
            });
            
            // 2. ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆ
            tdd.test('åç›Šæ€§ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½', () => {
                const data = ProfitabilityVisualizationSystem.getProfitabilityChartData();
                tdd.assertTrue(data !== undefined, 'ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã‚‹');
                tdd.assertTrue(data.timeSeriesData !== undefined, 'æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿æ§‹é€ ');
                tdd.assertTrue(Array.isArray(data.timeSeriesData.dailyProfits), 'æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—');
            });
            
            tdd.test('ROIæ™‚ç³»åˆ—å¤‰æ›æ©Ÿèƒ½', () => {
                const testData = {
                    timeSeriesData: {
                        dailyProfits: [
                            { date: '2024-01-01', roi: 100 },
                            { date: '2024-01-02', roi: -50 },
                            { date: '2024-01-03', roi: 75 }
                        ]
                    }
                };
                
                const chartData = ProfitabilityVisualizationSystem.convertToROITimeSeriesData(testData);
                
                tdd.assertEqual(chartData.labels.length, 3, 'ãƒ©ãƒ™ãƒ«æ•°ãŒæ­£ã—ã„');
                tdd.assertEqual(chartData.datasets[0].data.length, 3, 'ãƒ‡ãƒ¼ã‚¿æ•°ãŒæ­£ã—ã„');
                tdd.assertTrue(chartData.datasets[0].data.includes(100), 'ROIãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹');
            });
            
            tdd.test('ç©´é¦¬åŠ¹ç‡ãƒ‡ãƒ¼ã‚¿å¤‰æ›æ©Ÿèƒ½', () => {
                const testData = {
                    medium: { range: '3.1-7.0å€', roi: 15.5, hitRate: 0.25 },
                    high: { range: '7.1-15.0å€', roi: 45.2, hitRate: 0.15 }
                };
                
                const chartData = ProfitabilityVisualizationSystem.convertToUnderdogBarData(testData);
                
                tdd.assertEqual(chartData.labels.length, 2, 'ã‚«ãƒ†ã‚´ãƒªæ•°ãŒæ­£ã—ã„');
                tdd.assertTrue(chartData.datasets[0].data.includes(15.5), 'ROIãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹');
            });
            
            // 3. UIçµ±åˆãƒ†ã‚¹ãƒˆ
            tdd.test('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆæ©Ÿèƒ½', () => {
                ProfitabilityVisualizationSystem.createProfitabilityDashboard();
                
                const section = document.getElementById('learningGraphsSection');
                tdd.assertTrue(section.innerHTML.includes('åç›Šæ€§åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰'), 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«');
                tdd.assertTrue(section.innerHTML.includes('roiChart'), 'ROIãƒãƒ£ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒã‚¹');
                tdd.assertTrue(section.innerHTML.includes('underdogChart'), 'ç©´é¦¬ãƒãƒ£ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒã‚¹');
                tdd.assertTrue(section.innerHTML.includes('riskReturnChart'), 'ãƒªã‚¹ã‚¯ãƒ»ãƒªã‚¿ãƒ¼ãƒ³ãƒãƒ£ãƒ¼ãƒˆ');
                tdd.assertTrue(section.innerHTML.includes('efficiencyChart'), 'æŠ•è³‡åŠ¹ç‡ãƒãƒ£ãƒ¼ãƒˆ');
            });
            
            // 4. å®Ÿéš›ã®ãƒãƒ£ãƒ¼ãƒˆä½œæˆãƒ†ã‚¹ãƒˆ
            tdd.test('ROIæ¨ç§»ã‚°ãƒ©ãƒ•ä½œæˆï¼ˆå®Ÿéš›ã®Chart.jsï¼‰', () => {
                const chart = ProfitabilityVisualizationSystem.createROITrendChart();
                tdd.assertTrue(chart !== undefined, 'ãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹');
                
                // Chart.jsãƒãƒ£ãƒ¼ãƒˆã‹Mockãƒãƒ£ãƒ¼ãƒˆã‹ã‚’ç¢ºèª
                if (chart.type !== 'mock') {
                    tdd.assertTrue(chart.config !== undefined, 'Chart.jsè¨­å®šãŒå­˜åœ¨');
                    tdd.assertEqual(chart.config.type, 'line', 'ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ãŒç·šã‚°ãƒ©ãƒ•');
                }
            });
            
            tdd.test('ç©´é¦¬åŠ¹ç‡ã‚°ãƒ©ãƒ•ä½œæˆï¼ˆå®Ÿéš›ã®Chart.jsï¼‰', () => {
                const chart = ProfitabilityVisualizationSystem.createUnderdogEfficiencyChart();
                tdd.assertTrue(chart !== undefined, 'ãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹');
                
                if (chart.type !== 'mock') {
                    tdd.assertEqual(chart.config.type, 'bar', 'ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ãŒæ£’ã‚°ãƒ©ãƒ•');
                }
            });
            
            tdd.test('ãƒªã‚¹ã‚¯ãƒ»ãƒªã‚¿ãƒ¼ãƒ³æ•£å¸ƒå›³ä½œæˆ', () => {
                const chart = ProfitabilityVisualizationSystem.createRiskReturnScatterChart();
                tdd.assertTrue(chart !== undefined, 'ãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹');
                
                if (chart.type !== 'mock') {
                    tdd.assertEqual(chart.config.type, 'scatter', 'ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ãŒæ•£å¸ƒå›³');
                }
            });
            
            tdd.test('æŠ•è³‡åŠ¹ç‡ã‚¹ã‚³ã‚¢æ•£å¸ƒå›³ä½œæˆ', () => {
                const chart = ProfitabilityVisualizationSystem.createEfficiencyScatterChart();
                tdd.assertTrue(chart !== undefined, 'ãƒãƒ£ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹');
                
                if (chart.type !== 'mock') {
                    tdd.assertEqual(chart.config.type, 'scatter', 'ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ãŒæ•£å¸ƒå›³');
                }
            });
            
            // 5. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            tdd.test('ROIè‰²åˆ†ã‘æ©Ÿèƒ½', () => {
                const colors = ProfitabilityVisualizationSystem.config.colors;
                
                tdd.assertEqual(ProfitabilityVisualizationSystem.getColorByROI(75), colors.excellent, '75%ã¯å„ªç§€è‰²');
                tdd.assertEqual(ProfitabilityVisualizationSystem.getColorByROI(25), colors.good, '25%ã¯è‰¯å¥½è‰²');
                tdd.assertEqual(ProfitabilityVisualizationSystem.getColorByROI(-10), colors.poor, '-10%ã¯ä¸è‰¯è‰²');
            });
            
            tdd.test('ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½', () => {
                const context = { parsed: { y: 25.5, x: 10.2 } };
                
                const roiTooltip = ProfitabilityVisualizationSystem.customTooltipFormatter(context, 'ROI');
                const efficiencyTooltip = ProfitabilityVisualizationSystem.customTooltipFormatter(context, 'æŠ•è³‡åŠ¹ç‡');
                
                tdd.assertTrue(roiTooltip.includes('25.5%'), 'ROIãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å½¢å¼');
                tdd.assertTrue(efficiencyTooltip.includes('26ç‚¹'), 'æŠ•è³‡åŠ¹ç‡ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å½¢å¼');
            });
            
            // 6. çµ±åˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
            tdd.test('åç›Šæ€§ãƒ‡ãƒ¼ã‚¿ã¨ã®çµ±åˆ', () => {
                // ãƒ†ã‚¹ãƒˆç”¨è³­ã‘çµæœã‚’è¨˜éŒ²
                const betResult = {
                    horseNumber: '1',
                    horseName: 'TDDãƒ†ã‚¹ãƒˆé¦¬',
                    odds: 12.0,
                    popularity: 8,
                    betType: 'å˜å‹',
                    betAmount: 1000,
                    isHit: true,
                    returnAmount: 12000
                };
                
                ProfitabilityMetrics.recordBetResult(betResult);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚°ãƒ©ãƒ•ã«åæ˜ 
                const chartData = ProfitabilityVisualizationSystem.getProfitabilityChartData();
                tdd.assertTrue(chartData.investment.totalProfit > 0, 'åˆ©ç›ŠãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹');
                
                // ã‚°ãƒ©ãƒ•æ›´æ–°
                ProfitabilityVisualizationSystem.refreshAllCharts();
                tdd.assertTrue(true, 'ãƒ‡ãƒ¼ã‚¿çµ±åˆã¨ã‚°ãƒ©ãƒ•æ›´æ–°ãŒæˆåŠŸ');
            });
            
            tdd.test('åˆæœŸåŒ–ãƒ»æ›´æ–°ãƒ»ç ´æ£„ã‚µã‚¤ã‚¯ãƒ«', () => {
                // åˆæœŸåŒ–
                ProfitabilityVisualizationSystem.initialize();
                tdd.assertTrue(ProfitabilityVisualizationSystem.isInitialized, 'åˆæœŸåŒ–å®Œäº†');
                
                // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
                ProfitabilityVisualizationSystem.refreshAllCharts();
                tdd.assertTrue(ProfitabilityVisualizationSystem.charts.size > 0, 'ãƒãƒ£ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã‚‹');
                
                // çµ±è¨ˆã‚µãƒãƒªãƒ¼æ›´æ–°
                ProfitabilityVisualizationSystem.updateProfitabilitySummary();
                const summaryElement = document.getElementById('profitabilitySummary');
                tdd.assertTrue(summaryElement.innerHTML.includes('ç¾åœ¨ROI'), 'çµ±è¨ˆã‚µãƒãƒªãƒ¼æ›´æ–°');
                
                // ç ´æ£„
                ProfitabilityVisualizationSystem.destroy();
                tdd.assertTrue(!ProfitabilityVisualizationSystem.isInitialized, 'ç ´æ£„å®Œäº†');
            });
            
            // 7. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
            tdd.test('CSVå‡ºåŠ›æ©Ÿèƒ½ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒï¼‰', () => {
                // ãƒ†ã‚¹ãƒˆæ™‚ã¯è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–
                const csvData = ProfitabilityVisualizationSystem.exportToCSV(false);
                
                tdd.assertTrue(typeof csvData === 'string', 'CSVæ–‡å­—åˆ—è¿”å´');
                tdd.assertTrue(csvData.includes('æ—¥ä»˜,ROI(%),åˆ©ç›Š(å††),çš„ä¸­ç‡(%)'), 'CSVãƒ˜ãƒƒãƒ€ãƒ¼');
                tdd.assertTrue(csvData.split('\n').length > 1, 'è¤‡æ•°è¡Œãƒ‡ãƒ¼ã‚¿');
            });
            
            // 8. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œãƒ†ã‚¹ãƒˆ
            tdd.test('ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åˆ¶å¾¡æ©Ÿèƒ½', () => {
                // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                ProfitabilityVisualizationSystem.handleResize();
                tdd.assertTrue(true, 'ãƒªã‚µã‚¤ã‚ºå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãªã—');
                
                // ãƒ‡ãƒã‚¦ãƒ³ã‚·ãƒ³ã‚°æ©Ÿèƒ½
                ProfitabilityVisualizationSystem.debouncedUpdate();
                tdd.assertTrue(true, 'ãƒ‡ãƒã‚¦ãƒ³ã‚·ãƒ³ã‚°å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãªã—');
            });
            
            // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
            const success = tdd.displayResults();
            
            if (success) {
                console.log('ğŸ‰ TDD Green Phaseå®Œäº†ï¼ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼');
                
                // æˆåŠŸæ™‚ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚’å†åˆæœŸåŒ–ã—ã¦å®Ÿéš›ã®ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
                setTimeout(() => {
                    ProfitabilityVisualizationSystem.initialize();
                    console.log('ğŸ’ åç›Šæ€§ã‚°ãƒ©ãƒ•ã‚·ã‚¹ãƒ†ãƒ ãŒç¨¼åƒä¸­ã§ã™');
                }, 1000);
            } else {
                console.log('âš ï¸ ä¸€éƒ¨ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });
    </script>
</body>
</html>